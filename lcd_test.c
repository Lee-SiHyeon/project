/*
 * lcd_test.c
 *
 *  Created on: 2024. 7. 16.
 *      Author: yeeun99.kim
 */

#include "device_driver.h"
#include "lcd.h"
#include "lcd_test.h"
#include "game_object_queue.h"

#define Lcd_W 			320
#define Lcd_H 			240

#define Plane_W 			36
#define Plane_H 			24

#define MISSILE_W			8
#define MISSILE_H			8

GameObject plane;
#define MAX_MISSILES 5

//GameObject missiles[MAX_MISSILES];
GameObjectQueue missile_queue;

int score = 0;
int game_over = 0;

extern volatile int key_value;

/*
void Game_Init(void);
void Game_Loop(void);
void Update_Plane(int direction);
void Update_Missiles(void);
void Draw_GameObject(GameObject *obj);
void Check_Collision(void);
void Draw_Score(void);
void Clear_GameObject(GameObject *obj);
void Generate_Missile(GameObject *missile);
void Lcd_Clear_Area(int x1, int y1, int x2, int y2, unsigned short Color);
*/

void Generate_Missile(GameObject *missile);
void Draw_Image(int x, int y, int w, int h, const int *image);
void Clear_Image(int x, int y, int w, int h, unsigned short Color);
void DrawPlane(void);
void ClearPlane(void);
void DrawMissile(GameObject* missile);
void ClearMissile(GameObject* missile);
void Game_Init(void);
void Game_Plane_Move(void);
void Game_Missile_Generation(void);
void Game_Missile_Move(void);
void Game_Over(void);



const int Missile[MISSILE_W * MISSILE_H] = {
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFBE4, 0xFBE4, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0xFBE4, 0xFBE4, 0xFBE4, 0xFBE4, 0x0000, 0x0000, 0x0000, 0xFBE4, 0xFBE4, 0x0000, 0x0000, 0xFBE4, 0xFBE4, 0x0000,
		0x0000, 0xFBE4, 0xFBE4, 0x0000, 0x0000, 0xFBE4, 0xFBE4, 0x0000, 0x0000, 0x0000, 0xFBE4, 0xFBE4, 0xFBE4, 0xFBE4, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0xFBE4, 0xFBE4, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

const int Plane[Plane_W * Plane_H] = {
  // �̹��� ������ �迭
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D,
		0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x04FC, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x026D, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01EA, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x04FC,
		0x026D, 0x026D, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x026D, 0x0000, 0x04FC, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x04FC, 0x026D, 0x0000, 0x0000, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x04FC, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x04FC, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051C, 0x051C, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x049A, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051C, 0x051D,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051C, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x020B, 0x049A,
		0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051C, 0x04FB, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051C, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0168, 0x049A, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000,
		0x0168, 0x049A, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051C, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0168, 0x049A, 0x051D, 0x051D, 0x051D, 0x051D,
		0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0168, 0x049A, 0x051D, 0x051D, 0x051D, 0x051D, 0x051C, 0x051D, 0x051D,
		0x051D, 0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0168, 0x04DB, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000, 0x0000, 0x0000, 0x0168, 0x049A, 0x051D,
		0x051D, 0x051D, 0x051C, 0x051D, 0x051D, 0x051D, 0x051D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0168, 0x049A, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x051D, 0x0311, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0168, 0x049A, 0x051D, 0x051D, 0x051C, 0x051D, 0x051D, 0x051D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x020B, 0x04DB, 0x051D, 0x051D,
		0x051D, 0x051D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x020B, 0x04DB, 0x051D, 0x051D, 0x051D, 0x051D, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0168, 0x049A, 0x051D, 0x04FC, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0168, 0x049A,
		0x04FC, 0x04DB, 0x026D, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};


static void _Delay(int ms)
{
	volatile int i;
	for(i=0;i<(0x1000*ms);i++);
}
/*
void Game_Init(void)
{
    Lcd_Init();

    // Initialize plane
    plane.x = Lcd_W - 50;
    plane.y = Lcd_H/2 - 12;
    plane.width = 20;
    plane.height = 10;
    plane.image = Plane;

    // Initialize missiles
    int i = 0;
    for (; i < MAX_MISSILES; i++) {
        Generate_Missile(&missiles[i]);
    }

    score = 0;
    game_over = 0;
}

void Game_Loop(void)
{
    while (!game_over) {
        // Update plane based on input
        if (rand() % 1// check left button press) {
            Update_Plane(-1);
        } else if (rand() % 1//check right button press) {
            Update_Plane(1);
        }

        // Update missiles
        Update_Missiles();

        // Check for collisions
        Check_Collision();

        // Draw the updated scene
        Draw_Score();

        // Delay for a short period
        _Delay(50);
    }

    // Display Game Over
    Lcd_Draw_Box(60, 110, 180, 100, RED);
    Lcd_Set_Cursor(100, 150);
    Lcd_Draw_Box(90, 130, 60, 30, BLACK);
    Lcd_Set_Cursor(100, 150);
    // Print "Game Over" on LCD

    while (1); // Game over loop
}


void Update_Plane(int direction)
{
    Clear_GameObject(&plane);

    plane.x += direction * 5;
    if (plane.x < 0) plane.x = 0;
    if (plane.x > Lcd_W - plane.width) plane.x = Lcd_W - plane.width;

    Draw_GameObject(&plane);
}

void Update_Missiles(void)
{
	int i = 0;
    for (;i < MAX_MISSILES; i++) {
        Clear_GameObject(&missiles[i]);

        missiles[i].y += 5;
        if (missiles[i].y > Lcd_H) {
            Generate_Missile(&missiles[i]);
            score++;
        }

        Draw_GameObject(&missiles[i]);
    }
}

void Draw_GameObject(GameObject *obj)
{
	draw_image(obj->x, obj->y, obj->image, obj->width, obj->height);
}

void Clear_GameObject(GameObject *obj)
{
	clear_image(obj->x, obj->y, obj->width, obj->height, BLACK);
}



void Check_Collision(void)
{
	int i = 0;

    for (;i < MAX_MISSILES; i++) {
        if (missiles[i].x < plane.x + plane.width &&
            missiles[i].x + missiles[i].width > plane.x &&
            missiles[i].y < plane.y + plane.height &&
            missiles[i].y + missiles[i].height > plane.y) {
            game_over = 1;
        }
    }
}

void Draw_Score(void)
{
    char score_str[10];
    sprintf(score_str, "Score: %d", score);
    Lcd_Draw_Box(0, 0, 80, 20, BLACK);
    Lcd_Set_Cursor(0, 0);
    // Print score_str on LCD
}

void Lcd_Clear_Area(int x1, int y1, int x2, int y2, unsigned short Color){
	Lcd_Draw_Box(x1, y1, x2-x1, y2-y1, BLACK);
}
*/

void Generate_Missile(GameObject *missile)
{
    missile->x = 0;
    missile->y = rand() % (Lcd_H - 10);
    missile->width = MISSILE_W;
    missile->height = MISSILE_H;
    missile->image = Missile;

    Uart_Printf("y: %d\n", missile->y);
}

void Draw_Image(int x, int y, int w, int h, const int *image) {
	Lcd_Set_Windows(x, y, x + w - 1, y + h - 1);

	int i=0, j=0;

	for (;i<h;i++) {
		j = 0;
		for (;j<w;j++){
			Lcd_Put_Pixel(x+j, y+i, image[w*i+j]);
		}
	}
}

void Clear_Image(int x, int y, int w, int h, unsigned short Color) {
	Lcd_Set_Windows(x, y, x + w - 1, y + h - 1);

	int i=0, j=0;

	for (;i < w; i++) {
		j = 0;
		for (;j<h;j++){
			Lcd_Put_Pixel(x+i, y+j, Color);
		}
	}
}
void DrawPlane(void){
	Draw_Image(plane.x, plane.y, plane.width, plane.height, plane.image);
}
void ClearPlane(void){
	Clear_Image(plane.x, plane.y, plane.width, plane.height, BLACK);
}
void DrawMissile(GameObject* missile){
	Draw_Image(missile->x, missile->y, missile->width, missile->height, missile->image);
}
void ClearMissile(GameObject* missile){
	Clear_Image(missile->x, missile->y, missile->width, missile->height, BLACK);
}

void Game_Init(void)
{
    Lcd_Init();
    initQueue(&missile_queue);

    // Initialize plane
    plane.x = Lcd_W - 50;
    plane.y = Lcd_H/2 - Plane_H/2;
	plane.width = Plane_W;
	plane.height = Plane_H;
	plane.image = Plane;

	DrawPlane();

	score = 0;
    game_over = 0;
}

void Game_Plane_Move(void)
{
	int dy = 10;

	if(key_value==5){ //push sw0
		//clear previous image
		ClearPlane();

		//check borderline
		if(plane.y >= 15) plane.y -= dy;

		DrawPlane();
	}
	else if(key_value==6){ //push sw1
		//clear previous image
		ClearPlane();

		//check borderline
		if(plane.y <= 200) plane.y += dy;

		DrawPlane();
	}

	key_value = 0;

	//_Delay(120); //speed control
}

void Game_Missile_Generation(void)
{
    if(queueSize(&missile_queue)<5){
    	GameObject newMissile;
    	Generate_Missile(&newMissile);
    	enqueue(&missile_queue, newMissile);
    	DrawMissile(&newMissile);

    	Uart_Printf("%d\n", queueSize(&missile_queue));

    	//_Delay(5000); //wait 5 seconds
    }
}

void Game_Missile_Move(void)
{
	Game_Missile_Generation();

	int index = missile_queue.front;
	int count = missile_queue.size;

	int dx = 5;
	int i = 0;

	for (; i < count; i++) {
		GameObject *obj = &missile_queue.queue[index];

		ClearMissile(obj);

		obj->x += dx;

		if (obj->x < plane.x + plane.width &&
			obj->x + obj->width > plane.x &&
			obj->y < plane.y + plane.height &&
			obj->y + obj->height > plane.y) {
			game_over = 1;
		}

		if (obj->x >= 360) {
			GameObject temp;
			dequeue(&missile_queue, &temp);
		}
		else {
			DrawMissile(obj);

			index = (index + 1) % QUEUE_MAX_SIZE;
		}
	}
}

void Game_Over(void)
{
	if(game_over) {
		Lcd_Draw_Back_Color(RED);
		_Delay(300);
		Lcd_Clr_Screen();
		_Delay(300);
	}
}
